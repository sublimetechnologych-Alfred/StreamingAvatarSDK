<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Alfred con LiveKit</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    video { width: 640px; height: 360px; background: black; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Alfred (avatar interattivo)</h1>
  <button id="startBtn">Avvia Alfred</button>
  <br>
  <video id="avatarVideo" autoplay playsinline></video>

  <!-- LiveKit client -->
  <script type="module">
    import { Room } from "https://cdn.jsdelivr.net/npm/livekit-client/+esm";

    document.getElementById("startBtn").addEventListener("click", async () => {
      try {
        // 1. Crea nuova sessione dal backend
        const res = await fetch("/api/session", { method: "POST" });
        const result = await res.json();

        if (!res.ok || result.error) {
          alert("Errore creazione sessione: " + JSON.stringify(result));
          return;
        }

        // 2. Estraggo i dati principali
        const data = result.data;
        console.log("Session data:", data);

        const url = data.url;           // URL del server LiveKit
        const token = data.token;       // Token accesso
        const sessionId = data.session_id;

        console.log("Connetto a LiveKit:", url, sessionId);

        // 3. Connetto a LiveKit
        const room = new Room();
        await room.connect(url, token);

        // 4. Quando arriva un video → attaccalo al <video>
        room.on("trackSubscribed", (track, publication, participant) => {
          if (track.kind === "video") {
            const videoEl = document.getElementById("avatarVideo");
            track.attach(videoEl);
          }
        });

        alert("Alfred è partito!");
      } catch (err) {
        console.error("Errore:", err);
        alert("Errore avvio Alfred: " + err.message);
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Alfred (voce rassicurante, ~67 anni)</title>
</head>
<body>
  <h1>Alfred (voce rassicurante, ~67 anni)</h1>
  <video id="avatar" autoplay playsinline></video>
  <br>
  <button id="startBtn">Avvia Alfred</button>

  <script>
    const startBtn = document.getElementById("startBtn");
    const videoEl = document.getElementById("avatar");

    startBtn.onclick = async () => {
      try {
        // 1. Crea RTCPeerConnection
        const pc = new RTCPeerConnection();
        pc.ontrack = (event) => {
          videoEl.srcObject = event.streams[0];
        };

        // 2. Aggiungi traccia audio (opzionale microfono)
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        // 3. Crea un’offerta
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        // 4. Manda l’offerta al backend /api/session
        const resp = await fetch("/api/session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sdp: offer.sdp, type: offer.type })
        });

        const data = await resp.json();
        console.log("Risposta API:", data);

        if (!data.sdp) {
          throw new Error("Nessun SDP nella risposta!");
        }

        // 5. Imposta la remote description
        await pc.setRemoteDescription({
          type: "answer",
          sdp: data.sdp.sdp || data.sdp // dipende dal formato
        });

        alert("Alfred avviato con successo!");
      } catch (err) {
        console.error("Errore avvio Alfred:", err);
        alert("Errore avvio Alfred: " + err.message);
      }
    };
  </script>
</body>
</html>
